<!DOCTYPE html>
<html>
<head>
  <!-- ç§»é™¤ base targetï¼ŒGitHub Pages ä¸éœ€è¦ -->
  <!-- å¼•å…¥è–èª•é¢¨æ ¼å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Varela+Round&display=swap" rel="stylesheet">
  <!-- å¼•å…¥ QR Code ç”Ÿæˆåº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    :root {
      --xmas-red: #d42426;
      --xmas-green: #165b33;
      --xmas-gold: #f8b229;
      --xmas-cream: #f0f0d8;
      --overlay-bg: rgba(22, 91, 51, 0.95); /* æ·±ç¶ è‰²èƒŒæ™¯ */
    }

    body {
      font-family: 'Varela Round', sans-serif;
      margin: 0;
      padding: 0;
      /* ç›´ç«‹å¼å…¨è¢å¹•è¨­å®š */
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, var(--xmas-red) 0%, #8b0000 100%);
      color: white;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* é£„é›ªç‰¹æ•ˆå®¹å™¨ */
    #snow-container {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .snowflake {
      position: absolute;
      top: -10px;
      color: white;
      font-size: 1em;
      opacity: 0.8;
      animation: fall linear infinite;
    }

    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); }
      100% { transform: translateY(110vh) rotate(360deg); }
    }

    /* æ¨™é¡Œå€ (é ‚éƒ¨) */
    header {
      z-index: 10;
      text-align: center;
      padding: 15px 0;
      background: url('https://img.icons8.com/color/96/christmas-garland.png') repeat-x bottom;
      background-size: 50px;
      padding-bottom: 25px; /* ç•™çµ¦èŠ±ç’°ç©ºé–“ */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    h1 {
      font-family: 'Mountains of Christmas', cursive;
      margin: 0;
      font-size: 3rem;
      color: var(--xmas-gold);
      letter-spacing: 2px;
    }

    /* ä¸»ç•«é¢å€ (ä¸­é–“æ»¿ç‰ˆ) */
    .viewport {
      flex-grow: 1;
      position: relative;
      margin: 10px 20px;
      background: #000;
      border: 8px solid var(--xmas-gold);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(248, 178, 41, 0.5);
      z-index: 5;
    }

    /* åªé‡å° viewport å…§çš„ video å’Œ canvas è¨­å®šæ»¿ç‰ˆ */
    .viewport video, .viewport canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    /* ç¢ºä¿ QR Code å…§çš„ canvas/img ä¸å—å…¨è¢å¹•æ¨£å¼å½±éŸ¿ */
    #qrcode canvas, #qrcode img {
      position: static !important;
      width: auto !important;
      height: auto !important;
      max-width: 100%;
      display: block; /* é¿å…åº•éƒ¨ç™½é‚Š */
    }

    /* é¡åƒç¿»è½‰ (åªé‡å°è¦–è¨Šï¼Œè®“é è¦½åƒç…§é¡å­) */
    .viewport video { transform: scaleX(-1); }
    
    /* åº•éƒ¨æ“ä½œå€ (åŒ…å«ç´ æèˆ‡æŒ‰éˆ•) */
    .controls-area {
      z-index: 10;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-top: 4px solid var(--xmas-green);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* ç´ æåˆ— (æ©«å‘æ²å‹•å„ªåŒ–) */
    .sticker-bar {
      display: flex;
      gap: 15px;
      overflow-x: auto; /* å…è¨±æ©«å‘æ²å‹• */
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      min-height: 90px;
      align-items: center;
      
      /* è‡ªè¨‚æ²è»¸æ¨£å¼ */
      scrollbar-width: thin;
      scrollbar-color: var(--xmas-gold) rgba(0,0,0,0.3);
    }
    
    /* Webkit (Chrome/Safari) æ²è»¸æ¨£å¼ */
    .sticker-bar::-webkit-scrollbar {
      height: 8px; 
    }
    .sticker-bar::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    .sticker-bar::-webkit-scrollbar-thumb {
      background: var(--xmas-gold);
      border-radius: 4px;
    }
    
    .sticker-item {
      width: 70px;
      height: 70px;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
      flex-shrink: 0; 
    }
    .sticker-item:active { transform: scale(0.9); }

    /* æŒ‰éˆ•ç¾¤çµ„ */
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding-bottom: 20px; /* åº•éƒ¨ç•™ç™½ */
    }

    button {
      font-family: 'Mountains of Christmas', cursive;
      font-weight: bold;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 6px 0 rgba(0,0,0,0.3);
      transition: all 0.1s;
      min-width: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    button:active {
      transform: translateY(6px);
      box-shadow: none;
    }

    .btn-snap {
      background: var(--xmas-green);
      color: white;
      border: 2px solid #fff;
    }
    
    .btn-action {
      background: var(--xmas-gold);
      color: #8b0000;
    }

    /* å€’æ•¸è¨ˆæ™‚ */
    #countdown-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 15rem;
      font-family: 'Mountains of Christmas', cursive;
      color: var(--xmas-gold);
      text-shadow: 0 0 20px var(--xmas-red);
      z-index: 20;
      background: rgba(0,0,0,0.3);
      display: none;
    }

    /* è¼‰å…¥èˆ‡ QR Code å±¤ (è“‹ç‰ˆ) */
    .overlay-layer {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: var(--overlay-bg);
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #qrcode {
      background: white;
      padding: 20px;
      border-radius: 15px;
      border: 5px solid var(--xmas-gold);
      margin: 20px 0;
      display: inline-block;
    }

    /* ç…§ç‰‡ç‰†å±¤ (è“‹ç‰ˆ) */
    .gallery-view {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: url('https://www.transparenttextures.com/patterns/snow.png'), var(--xmas-red);
      z-index: 60;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      box-sizing: border-box;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 100%;
      overflow-y: auto;
      padding-bottom: 100px;
    }

    .gallery-item {
      background: white;
      padding: 8px 8px 30px 8px; /* æ‹ç«‹å¾—æ¨£å¼ */
      transform: rotate(var(--rot));
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* å…±ç”¨éš±è— */
    .hidden { display: none !important; }

    /* è£é£¾ç·š */
    .deco-line {
      width: 100%;
      height: 10px;
      background: repeating-linear-gradient(
        45deg,
        var(--xmas-red),
        var(--xmas-red) 20px,
        white 20px,
        white 40px
      );
      position: absolute;
      bottom: 0;
    }

  </style>
</head>
<body>

  <!-- é£„é›ªç‰¹æ•ˆå®¹å™¨ -->
  <div id="snow-container"></div>

  <header>
    <h1>ğŸ„ è–èª•æ‹è²¼æ©Ÿ ğŸ…</h1>
  </header>

  <!-- ä¸­é–“æ‹æ”/ç·¨è¼¯è¦–çª— -->
  <div class="viewport">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>
    <div id="countdown-overlay">5</div>
  </div>

  <!-- åº•éƒ¨æ“ä½œå€ -->
  <div class="controls-area">
    
    <!-- ç´ æé¸å–® -->
    <div id="sticker-container" class="sticker-bar hidden">
      <!-- ç´ æå°‡ç”± JS è¼‰å…¥ -->
    </div>

    <!-- æŒ‰éˆ•å€ -->
    <div class="btn-group">
      <!-- æ‹æ”æŒ‰éˆ• -->
      <button id="btn-snap" class="btn-snap" onclick="startCountdown()">
        ğŸ“¸ æ‹ä¸€å¼µ
      </button>

      <!-- ç…§ç‰‡ç‰†æŒ‰éˆ• -->
      <button id="btn-gallery" class="btn-action" onclick="openGallery()">
        ğŸ–¼ï¸ æ¬£è³ä½œå“
      </button>

      <!-- é‡æ‹/ä¸Šå‚³ (ç·¨è¼¯æ¨¡å¼) -->
      <button id="btn-retake" class="btn-action hidden" onclick="resetCamera()">
        ğŸ”„ é‡æ‹
      </button>
      <button id="btn-upload" class="btn-snap hidden" onclick="savePhoto()">
        ğŸ’¾ å„²å­˜
      </button>
    </div>
  </div>
  
  <div class="deco-line"></div>

  <!-- é®ç½©å±¤ï¼šè™•ç†ä¸­ -->
  <div id="loading" class="overlay-layer hidden">
    <h2 style="font-size: 2rem; margin-bottom: 20px;">ğŸ¦Œ æ­£åœ¨åŒ…è£ç¦®ç‰©...</h2>
    <div style="font-size: 4rem;">ğŸ›·</div>
  </div>

  <!-- é®ç½©å±¤ï¼šçµæœèˆ‡ä¸‹è¼‰ -->
  <div id="qrcode-container" class="overlay-layer hidden">
    <h2 style="font-size: 2.5rem; color: var(--xmas-gold);">âœ¨ å„²å­˜å®Œæˆï¼ âœ¨</h2>
    
    <!-- é è¦½ç¸®åœ– (å–ä»£ QR Code ä½ç½®) -->
    <div style="background:white; padding:10px; border-radius:15px; border:5px solid var(--xmas-gold); margin: 20px 0; max-height: 40vh;">
      <img id="result-preview" style="max-height: 100%; max-width: 250px; display: block;" />
    </div>

    <!-- ä¸‹è¼‰æŒ‰éˆ• -->
    <a id="download-btn" href="#" download="xmas_photo.jpg" style="text-decoration: none;">
      <button class="btn-snap" style="font-size: 1.5rem; padding: 10px 30px;">
        ğŸ“¥ ä¸‹è¼‰åˆ°è£ç½®
      </button>
    </a>

    <!-- åˆ†äº« App çš„ QR Code -->
    <div style="margin-top: 20px; font-size: 0.9rem; color: #ccc;">
      <div id="qrcode" style="padding: 5px; border-width: 2px;"></div>
      <p style="margin-top:5px">æƒæåˆ†äº«æ­¤ç¨‹å¼</p>
    </div>

    <button class="btn-action" onclick="resetApp()" style="margin-top: 15px;">
      å†ç©ä¸€æ¬¡ ğŸ
    </button>
  </div>

  <!-- é®ç½©å±¤ï¼šç…§ç‰‡ç‰† -->
  <div id="gallery-view" class="gallery-view hidden">
    <h2 style="font-size: 2.5rem; color: white; margin-bottom: 20px; font-family: 'Mountains of Christmas';">ğŸŒŸ æˆ‘çš„è–èª•å›æ†¶ ğŸŒŸ</h2>
    <div id="gallery-grid" class="gallery-grid">
      <!-- ç…§ç‰‡å‹•æ…‹æ’å…¥ -->
    </div>
    <button class="btn-action" onclick="closeGallery()" style="position: absolute; bottom: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
      è¿”å›æ‹è²¼æ©Ÿ
    </button>
  </div>

  <script>
    // --- éœæ…‹è³‡æºè¨­å®š (GitHub Pages é©ç”¨) ---
    // å…§å»º SVG ç´ æï¼Œå–ä»£é›²ç«¯ç¡¬ç¢Ÿè®€å–
    const ASSETS = {
      stickers: [
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxwYXRoIGZpbGw9IiNlNzRjM2MiIGQ9Ik0yNTYgMzJMMzIgNDE2aDQ0OEwyNTYgMzJ6Ii8+PHBhdGggZmlsbD0iIzJjM2UzMCIgZD0iTTI1NiAzdjEwN2wtNjggMTE4IDY4IDExOHY2N2w4Ni0xNTBoLTQ4bDc2LTEzM2gtNjR6IiBvcGFjaXR5PSIuMiIvPjwvc3ZnPg==", // è–èª•å¸½
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggZD0iTTEyIDJ2MjBtLTEwLTEwaDIwbS0zLjUgMy41bC0xMy0xM20wIDEzbDEzLTEzIiBzdHJva2U9IiM4N2NlZWIiLz48L3N2Zz4=", // é›ªèŠ±
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPjxwYXRoIGZpbGw9IiNmOGIyMjkiIGQ9Ik0yNTYgMzhMMzIgNDE2aDQ0OEwyNTYgMzh6IiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=", // é‡‘è‰²ä¸‰è§’
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9â€œMTgiIGhlaWdodD0iMTgiIHJ4PSIyIiByeT0iMiIvPjwvc3ZnPg==",
        "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmFmY2MiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjAuODQgNC42MWE1LjUgNS41IDAgMCAwLTcuNzggMGwtLjA2LjA2LS4wNi0uMDZhNS41IDUuNSAwIDAgMC03Ljc4IDcuNzhsNy44NCA3Ljg0IDcuODQtNy44NGE1LjUgNS41IDAgMCAwIDAtNy43OHoiPjwvcGF0aD48L3N2Zz4=" // æ„›å¿ƒ
      ]
    };

    // --- æœ¬åœ°å„²å­˜æœå‹™ (å–ä»£ Google Drive) ---
    const LocalGallery = {
      KEY: 'xmas_booth_photos',
      save: function(base64) {
        let photos = this.getAll();
        // åŠ å…¥æ–°ç…§ç‰‡åˆ°é–‹é ­
        photos.unshift(base64);
        // é™åˆ¶å„²å­˜æ•¸é‡ (æœ€å¤š 12 å¼µï¼Œé¿å… LocalStorage çˆ†æ»¿)
        if (photos.length > 12) photos = photos.slice(0, 12);
        try {
          localStorage.setItem(this.KEY, JSON.stringify(photos));
          return true;
        } catch (e) {
          alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹æ¸…é™¤ç€è¦½å™¨è³‡æ–™");
          return false;
        }
      },
      getAll: function() {
        const data = localStorage.getItem(this.KEY);
        return data ? JSON.parse(data) : [];
      }
    };

    // --- å…¨åŸŸè®Šæ•¸ ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const stickers = [];
    let capturedImage = null;
    let isDragging = false, isResizing = false;
    let selectedStickerIndex = -1;
    let dragStartX, dragStartY;

    // --- ç¨‹å¼é€²å…¥é» ---
    window.onload = function() {
      createSnow();
      initCamera();
      loadStickers();
      
      // ç”Ÿæˆåˆ†äº«é€£çµ QR Code
      new QRCode(document.getElementById("qrcode"), {
        text: window.location.href,
        width: 80,
        height: 80,
        colorDark : "#165b33",
        colorLight : "#ffffff"
      });
    };

    // --- é£„é›ªç‰¹æ•ˆ ---
    function createSnow() {
      const container = document.getElementById('snow-container');
      const symbols = ['â„', 'â…', 'â†', 'â€¢'];
      for (let i = 0; i < 30; i++) {
        const span = document.createElement('span');
        span.className = 'snowflake';
        span.innerText = symbols[Math.floor(Math.random() * symbols.length)];
        span.style.left = Math.random() * 100 + 'vw';
        span.style.animationDuration = (Math.random() * 3 + 2) + 's';
        span.style.fontSize = (Math.random() * 1.5 + 0.5) + 'em';
        span.style.animationDelay = Math.random() * 5 + 's';
        container.appendChild(span);
      }
    }

    // --- æ”å½±æ©Ÿ (å„ªåŒ–è§£æåº¦) ---
    async function initCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ä¸æ”¯æ´æ”å½±æ©Ÿ"); return;
      }
      try {
        // ä¿®æ”¹ï¼šå„ªå…ˆè«‹æ±‚ 1080p (Full HD) æˆ–æ›´é«˜ç•«è³ª
        const constraints = {
          video: {
            facingMode: "user",
            // ç›´ç«‹å¼æµ·å ±æ©Ÿå»ºè­°ä½¿ç”¨ Portrait æ¯”ä¾‹
            width: { ideal: 1080 },
            height: { ideal: 1920 },
            aspectRatio: { ideal: 9/16 }
          },
          audio: false
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        handleStreamSuccess(stream);
      } catch (err) {
        console.warn("é«˜ç•«è³ªè¨­å®šå¤±æ•—ï¼Œå˜—è©¦é™ç´š...", err);
        try {
          // é™ç´šå˜—è©¦ï¼š720p
           const constraints720 = {
            video: {
              facingMode: "user",
              width: { ideal: 720 },
              height: { ideal: 1280 }
            }
          };
          const stream = await navigator.mediaDevices.getUserMedia(constraints720);
          handleStreamSuccess(stream);
        } catch (e) { 
           // æœ€å¾Œæ‰‹æ®µï¼šé€šç”¨è¨­å®š
           try {
             const stream = await navigator.mediaDevices.getUserMedia({ video: true });
             handleStreamSuccess(stream);
           } catch(e2) {
             alert("ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ: " + e2.message);
           }
        }
      }
    }

    function handleStreamSuccess(stream) {
      video.srcObject = stream;
      video.onloadedmetadata = () => video.play();
    }

    // --- ç´ æè¼‰å…¥ (æ”¹ç‚ºè®€å–éœæ…‹ SVG) ---
    function loadStickers() {
      const container = document.getElementById('sticker-container');
      container.innerHTML = "";
      
      ASSETS.stickers.forEach(base64 => {
        const img = document.createElement('img');
        img.src = base64;
        img.className = 'sticker-item';
        img.onclick = () => addStickerToCanvas(img);
        container.appendChild(img);
      });
    }

    // --- æ‹ç…§èˆ‡æµç¨‹æ§åˆ¶ ---
    function startCountdown() {
      const overlay = document.getElementById('countdown-overlay');
      document.getElementById('btn-snap').classList.add('hidden');
      document.getElementById('btn-gallery').classList.add('hidden');
      overlay.style.display = 'flex';
      
      let count = 5;
      overlay.innerText = count;
      const timer = setInterval(() => {
        count--;
        if (count > 0) {
          overlay.innerText = count;
        } else {
          clearInterval(timer);
          overlay.style.display = 'none';
          takePhoto();
        }
      }, 1000);
    }

    function takePhoto() {
      // è¨­å®š Canvas è§£æåº¦ (å„ªå…ˆä½¿ç”¨å½±ç‰‡å¯¦éš›è§£æåº¦)
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // ç›´æ¥ç¹ªè£½åŸå§‹å½±åƒ (ä¸é¡åƒ)
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      capturedImage = new Image();
      capturedImage.src = canvas.toDataURL('image/png');
      capturedImage.onload = () => drawCanvas();

      // UI åˆ‡æ›
      video.classList.add('hidden');
      canvas.classList.remove('hidden');
      document.getElementById('sticker-container').classList.remove('hidden');
      
      document.getElementById('btn-retake').classList.remove('hidden');
      document.getElementById('btn-upload').classList.remove('hidden');
    }

    function resetCamera() {
      stickers.length = 0;
      capturedImage = null;
      selectedStickerIndex = -1;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      video.classList.remove('hidden');
      canvas.classList.add('hidden');
      document.getElementById('sticker-container').classList.add('hidden');
      
      document.getElementById('btn-snap').classList.remove('hidden');
      document.getElementById('btn-gallery').classList.remove('hidden');
      document.getElementById('btn-retake').classList.add('hidden');
      document.getElementById('btn-upload').classList.add('hidden');
    }

    function resetApp() {
      document.getElementById('qrcode-container').classList.add('hidden');
      resetCamera();
    }

    // --- Canvas æ“ä½œ (ç¸®æ”¾èˆ‡æ‹–æ›³) ---
    function addStickerToCanvas(imgElem) {
      const size = Math.min(canvas.width, canvas.height) * 0.25; // ç¨å¾®å¤§ä¸€é»
      const aspectRatio = imgElem.naturalWidth / imgElem.naturalHeight;
      stickers.push({
        img: imgElem,
        x: (canvas.width - size)/2,
        y: (canvas.height - size/aspectRatio)/2,
        width: size,
        height: size/aspectRatio,
        aspectRatio: aspectRatio
      });
      selectedStickerIndex = stickers.length - 1;
      drawCanvas();
    }

    function drawCanvas() {
      if (!capturedImage) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(capturedImage, 0, 0);
      
      stickers.forEach((s, i) => {
        ctx.drawImage(s.img, s.x, s.y, s.width, s.height);
        
        if (i === selectedStickerIndex) {
          ctx.save();
          ctx.strokeStyle = '#f8b229'; // é‡‘è‰²å¤–æ¡†
          ctx.lineWidth = 5;
          ctx.setLineDash([15, 10]);
          ctx.strokeRect(s.x, s.y, s.width, s.height);
          
          // æ§åˆ¶é»
          ctx.beginPath();
          ctx.fillStyle = '#d42426'; // ç´…è‰²æ§åˆ¶é»
          ctx.arc(s.x + s.width, s.y + s.height, 15, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
      });
    }

    // äº‹ä»¶ç›£è½ (æ”¯æ´è§¸æ§èˆ‡æ»‘é¼ )
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('touchstart', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('touchmove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchend', handleEnd);

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
      const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
      return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    function handleStart(e) {
      if(e.type === 'touchstart') e.preventDefault();
      const pos = getPos(e);
      let hit = false;
      
      // æª¢æŸ¥æ§åˆ¶é»
      if (selectedStickerIndex !== -1) {
        const s = stickers[selectedStickerIndex];
        const dx = pos.x - (s.x + s.width);
        const dy = pos.y - (s.y + s.height);
        if (Math.sqrt(dx*dx + dy*dy) < 40) {
          isResizing = true;
          isDragging = false;
          hit = true;
          return;
        }
      }

      // æª¢æŸ¥æœ¬é«”
      for (let i = stickers.length - 1; i >= 0; i--) {
        const s = stickers[i];
        if (pos.x >= s.x && pos.x <= s.x + s.width && pos.y >= s.y && pos.y <= s.y + s.height) {
          selectedStickerIndex = i;
          stickers.push(stickers.splice(i, 1)[0]);
          selectedStickerIndex = stickers.length - 1;
          isDragging = true;
          isResizing = false;
          dragStartX = pos.x - s.x;
          dragStartY = pos.y - s.y;
          hit = true;
          drawCanvas();
          break;
        }
      }
      
      if (!hit) {
        selectedStickerIndex = -1;
        drawCanvas();
      }
    }

    function handleMove(e) {
      if (selectedStickerIndex === -1) return;
      if (e.type === 'touchmove') e.preventDefault();
      const pos = getPos(e);
      const s = stickers[selectedStickerIndex];

      if (isResizing) {
        let w = pos.x - s.x;
        if (w < 50) w = 50;
        s.width = w;
        s.height = w / s.aspectRatio;
        drawCanvas();
      } else if (isDragging) {
        s.x = pos.x - dragStartX;
        s.y = pos.y - dragStartY;
        drawCanvas();
      }
    }

    function handleEnd() {
      isDragging = false;
      isResizing = false;
    }

    // --- å„²å­˜ (æ”¹ç‚ºæœ¬æ©Ÿå„²å­˜èˆ‡ä¸‹è¼‰) ---
    function savePhoto() {
      // å–æ¶ˆé¸å–æ¡†
      selectedStickerIndex = -1;
      drawCanvas();
      
      document.getElementById('loading').classList.remove('hidden');

      // æ¨¡æ“¬è™•ç†æ™‚é–“
      setTimeout(() => {
        // ç¸®æ”¾èˆ‡å£“ç¸®
        const MAX = 1000;
        let w = canvas.width, h = canvas.height;
        if (w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } }
        else { if(h > MAX) { w *= MAX/h; h = MAX; } }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w;
        tempCanvas.height = h;
        tempCanvas.getContext('2d').drawImage(canvas, 0, 0, w, h);
        
        const jpgBase64 = tempCanvas.toDataURL('image/jpeg', 0.8);

        // 1. å­˜å…¥ LocalStorage
        LocalGallery.save(jpgBase64);

        // 2. é¡¯ç¤ºçµæœé èˆ‡ä¸‹è¼‰æŒ‰éˆ•
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('qrcode-container').classList.remove('hidden');
        
        // è¨­å®šé è¦½åœ–èˆ‡ä¸‹è¼‰é€£çµ
        document.getElementById('result-preview').src = jpgBase64;
        const dlBtn = document.getElementById('download-btn');
        dlBtn.href = jpgBase64;
        // æª”ååŠ ä¸Šæ™‚é–“æˆ³
        dlBtn.download = `xmas_${new Date().getTime()}.jpg`;

      }, 1000);
    }

    // --- ç…§ç‰‡ç‰† (æ”¹ç‚ºè®€å– LocalStorage) ---
    function openGallery() {
      const g = document.getElementById('gallery-view');
      const grid = document.getElementById('gallery-grid');
      g.classList.remove('hidden');
      grid.innerHTML = "";
      
      const photos = LocalGallery.getAll();
      
      if(photos.length === 0) {
        grid.innerHTML = "<div style='color:white; grid-column:span 2; text-align:center; padding-top:20px;'>é‚„æ²’æœ‰ç…§ç‰‡å–”ï¼<br>å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­</div>";
        return;
      }

      photos.forEach(url => {
        const div = document.createElement('div');
        div.className = 'gallery-item';
        div.style.setProperty('--rot', (Math.random()*6-3)+'deg');
        const img = document.createElement('img');
        img.src = url;
        div.appendChild(img);
        grid.appendChild(div);
      });
    }

    function closeGallery() {
      document.getElementById('gallery-view').classList.add('hidden');
    }
  </script>
</body>
</html>
